<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>4LEAF Tobacco Checker</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0"
    />

    <!-- No iOS PWA meta tags so camera works in Safari -->
    <script src="https://cdn.tailwindcss.com"></script>

    <script
      crossorigin
      src="https://unpkg.com/react@18/umd/react.production.min.js"
    ></script>
    <script
      crossorigin
      src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"
    ></script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  </head>

  <body class="bg-gray-100">
    <div id="root"></div>

    <!-- Embedded UPC CSV (from utl-2026-01-12.csv) -->
    <script>
      window.UPC_CSV = String.raw`"Trade Name","Packaging/Brand Style",UPC,"Carton Name","UPC (Carton or Roll)",Manufacturer
"1839 Blue 100s Filtered Cigarettes","20 ct Box",879982001196,"10 pk Carton",879982001233,"U.S. FLUE-CURED TOBACCO GROWERS, INC."
"1839 Blue King Filtered Cigarettes","20 ct Box",879982000885,"10 pk Carton",879982000892,"U.S. FLUE-CURED TOBACCO GROWERS, INC."
"1839 Blue Premium (16 oz) Pipe Tobacco","1 ct Bag",879982002919,,,"U.S. FLUE-CURED TOBACCO GROWERS, INC."
"1839 Blue Premium (16 oz) Roll Your Own Tobacco","1 ct Bag",187700000988,,,"U.S. FLUE-CURED TOBACCO GROWERS, INC."
"1839 Blue Premium (6 oz) Pipe Tobacco","1 ct Bag",879982002858,,,"U.S. FLUE-CURED TOBACCO GROWERS, INC."
"1839 Blue Premium (6 oz) Roll Your Own Tobacco","1 ct Bag",187700000957,,,"U.S. FLUE-CURED TOBACCO GROWERS, INC."
"1839 Red 100s Filtered Cigarettes","20 ct Box",879982001189,"10 pk Carton",879982001226,"U.S. FLUE-CURED TOBACCO GROWERS, INC."
"1839 Red King Filtered Cigarettes","20 ct Box",879982000854,"10 pk Carton",879982000861,"U.S. FLUE-CURED TOBACCO GROWERS, INC."
"1839 Red Premium (16 oz) Pipe Tobacco","1 ct Bag",879982002926,,,"U.S. FLUE-CURED TOBACCO GROWERS, INC."
"1839 Red Premium (16 oz) Roll Your Own Tobacco","1 ct Bag",187700000971,,,"U.S. FLUE-CURED TOBACCO GROWERS, INC."
"1839 Red Premium (6 oz) Pipe Tobacco","1 ct Bag",879982002865,,,"U.S. FLUE-CURED TOBACCO GROWERS, INC."
"1839 Red Premium (6 oz) Roll Your Own Tobacco","1 ct Bag",187700000940,,,"U.S. FLUE-CURED TOBACCO GROWERS, INC."
"1839 Silver 100s Filtered Cigarettes","20 ct Box",879982001202,"10 pk Carton",879982001240,"U.S. FLUE-CURED TOBACCO GROWERS, INC."
"1839 Silver King Filtered Cigarettes","20 ct Box",879982001158,"10 pk Carton",879982001165,"U.S. FLUE-CURED TOBACCO GROWERS, INC."
"187 Nicaraguan Maduro Sixty 6 x 60 Cigars",,,"25 pk Bundle",856713003964,"Intertabac Imports Corp."
"187 Nicaraguan Maduro Toro 6 x 50 Cigars",,,"25 pk Bundle",856713003865,"Intertabac Imports Corp."
"1st Class Blue 100s Filtered Cigarettes","20 ct Box",708926641252,"10 pk Carton",708926641245,"U.S. FLUE-CURED TOBACCO GROWERS, INC."
"1st Class Blue King Filtered Cigarettes","20 ct Box",708926630225,"10 pk Carton",708926630218,"U.S. FLUE-CURED TOBACCO GROWERS, INC."
"1st Class Red 100s Filtered Cigarettes","20 ct Box",708926641153,"10 pk Carton",708926641146,"U.S. FLUE-CURED TOBACCO GROWERS, INC."
"1st Class Red King Filtered Cigarettes","20 ct Box",708926630157,"10 pk Carton",708926630140,"U.S. FLUE-CURED TOBACCO GROWERS, INC."
"1st Class Silver 100s Filtered Cigarettes","20 ct Box",708926641450,"10 pk Carton",708926641443,"U.S. FLUE-CURED TOBACCO GROWERS, INC."
"20 Acre Farm Gordito 6 x 60 Cigars","1 ct Cello",818578019061,"20 pk Wood Box",818578019108,"SWI-DE, LLC d/b/a Drew Estate"
"20 Acre Farm Robusto 5 1/4 x 54 Cigars","1 ct Cello",818578019047,"20 pk Wood Box",818578019085,"SWI-DE, LLC d/b/a Drew Estate"
"20 Acre Farm Toro 6 x 52 Cigars","1 ct Cello",818578019054,"20 pk Wood Box",818578019092,"SWI-DE, LLC d/b/a Drew Estate"
"211 Nicaraguan Connecticut Sixty 6 x 60 Cigars",,,"25 pk Bundle",856713005043,"Intertabac Imports Corp."
"211 Nicaraguan Connecticut Toro 6 x 50 Cigars",,,"25 pk Bundle",856713005050,"Intertabac Imports Corp."
"24/7 Gold 100s Filtered Cigarettes","20 ct Box",685141910076,"10 pk Carton",685141913077,"Xcaliber International, Ltd., L.L.C."
"24/7 Gold King Filtered Cigarettes","20 ct Box",685141910045,"10 pk Carton",685141913046,"Xcaliber International, Ltd., L.L.C."
"24/7 Red 100s Filtered Cigarettes","20 ct Box",685141910038,"10 pk Carton",685141913039,"Xcaliber International, Ltd., L.L.C."
"24/7 Red King Filtered Cigarettes","20 ct Box",685141910007,"10 pk Carton",685141913008,"Xcaliber International, Ltd., L.L.C."
"24/7 Silver 100s Filtered Cigarettes","20 ct Box",685141910113,"10 pk Carton",685141913114,"Xcaliber International, Ltd., L.L.C."
"38 Special Blue 100s Filtered Cigars","20 ct Box",844504003132,"10 pk Carton",844504003187,"Lake Erie Tobacco Company"
"38 Special Original 100s Filtered Cigars","20 ct Box",844504003125,"10 pk Carton",844504003170,"Lake Erie Tobacco Company"
"4K's Wraps Cigar Wrappers","4 ct Pouch",842426162654,"30 pk Display Box",842426162661,"Rolida Investments, Inc."
"5150 Nicaraguan Sumatra Sixty 6 x 60 Cigars",,,"25 pk Bundle",856713004138,"Intertabac Imports Corp."
"5150 Nicaraguan Sumatra Toro 6 x 50 Cigars",,,"25 pk Bundle",856713003926,"Intertabac Imports Corp."
"601 Blue Maduro Robusto 5 1/4 x 52 Cigars",,,"20 pk Wood Box",9090900296,"Espinosa Premium Cigars"
"601 Blue Maduro Toro 6 1/4 x 54 Cigars",,,"20 pk Wood Box",9090900294,"Espinosa Premium Cigars"
"601 Red Habano Robusto 5 x 50 Cigars",,,"20 pk Wood Box",9090900276,"Espinosa Premium Cigars"
"601 Red Habano Toro 6 x 50 Cigars",,,"20 pk Wood Box",9090900274,"Espinosa Premium Cigars"
"A Bronx Tale Calogero Gordo 6 x 60 Cigars",,,"20 pk Wood Box",783583328289,"All American Tobacco LLC for Zander Greg Imports"
"A Bronx Tale Calogero Robusto 5 x 52 Cigars",,,"20 pk Wood Box",783583328272,"All American Tobacco LLC for Zander Greg Imports"
"A Bronx Tale Calogero Toro 6 x 54 Cigars",,,"20 pk Wood Box",783583328265,"All American Tobacco LLC for Zander Greg Imports"
"A Bronx Tale Calogero Torpedo 6 x 52 Cigars",,,"20 pk Wood Box",783583328296,"All American Tobacco LLC for Zander Greg Imports"
"A Bronx Tale Limited Edition Toro 6 1/2 x 54 Cigars",,,"10 pk Wood Box",783583327947,"All American Tobacco LLC for Zander Greg Imports"
"A Bronx Tale Sonny Limited Edition Toro 6 1/2 x 54 Cigars",,,"12 pk Wood Box",783583328739,"All American Tobacco LLC for Zander Greg Imports"
"Accomplice Classic Robusto 5 x 50 Cigars",,695510125505,"20 pk Wood Box",695510125512,"Principle Cigars, Inc."
"Accomplice Classic Toro 6 x 52 Cigars",,695510125529,"20 pk Wood Box",695510125604,"Principle Cigars, Inc."
"Accomplice Connecticut Toro 6 x 52 Cigars",,695510125598,"20 pk Wood Box",695510125604,"Principle Cigars, Inc."
"Accomplice Maduro Robusto 5 x 50 Cigars",,695510125703,"20 pk Wood Box",695510125710,"Principle Cigars, Inc."
... (rest of CSV rows from utl-2026-01-12.csv go here)`;
    </script>

    <script type="text/babel">
      const { useState, useRef, useEffect } = React;

      // Parse CSV once into a Set of approved UPC strings
      function buildApprovedUPCSet(csvText) {
        const approved = new Set();
        if (!csvText) return approved;

        const lines = csvText.split(/\r?\n/);
        if (lines.length < 2) return approved;

        const header = lines[0].split(",");
        const upcIndex = header.findIndex(
          (h) => h.replace(/"/g, "").trim() === "UPC"
        );
        const cartonIndex = header.findIndex(
          (h) => h.replace(/"/g, "").trim() === "UPC (Carton or Roll)"
        );

        for (let i = 1; i < lines.length; i++) {
          const line = lines[i];
          if (!line.trim()) continue;

          const cols = parseCsvLine(line);

          if (upcIndex >= 0 && cols[upcIndex]) {
            const code = normalizeUPC(cols[upcIndex]);
            if (code) approved.add(code);
          }
          if (cartonIndex >= 0 && cols[cartonIndex]) {
            const code = normalizeUPC(cols[cartonIndex]);
            if (code) approved.add(code);
          }
        }
        return approved;
      }

      // Simple CSV parser (handles quoted commas)
      function parseCsvLine(line) {
        const result = [];
        let current = "";
        let inQuotes = false;
        for (let i = 0; i < line.length; i++) {
          const ch = line[i];
          if (ch === '"' && line[i + 1] === '"') {
            current += '"';
            i++;
          } else if (ch === '"') {
            inQuotes = !inQuotes;
          } else if (ch === "," && !inQuotes) {
            result.push(current);
            current = "";
          } else {
            current += ch;
          }
        }
        result.push(current);
        return result;
      }

      function normalizeUPC(value) {
        if (!value) return "";
        return String(value).replace(/\D/g, "");
      }

      const APPROVED_UPCS = buildApprovedUPCSet(window.UPC_CSV);

      function App() {
        const videoRef = useRef(null);
        const canvasRef = useRef(null);
        const [scanning, setScanning] = useState(false);
        const [cameraError, setCameraError] = useState(null);
        const [showVideo, setShowVideo] = useState(false);
        const [isRearCamera, setIsRearCamera] = useState(true);
        const [lastScannedCode, setLastScannedCode] = useState(null);
        const [approvalStatus, setApprovalStatus] = useState(null);
        const scanIntervalRef = useRef(null);
        const streamRef = useRef(null);

        useEffect(() => () => stopScanning(), []);

        const stopScanning = () => {
          setScanning(false);
          setShowVideo(false);
          if (scanIntervalRef.current) {
            clearInterval(scanIntervalRef.current);
            scanIntervalRef.current = null;
          }
          if (streamRef.current) {
            streamRef.current.getTracks().forEach((t) => t.stop());
            streamRef.current = null;
          }
        };

        const handleCameraError = (err) => {
          console.error("Camera error:", err?.name, err?.message);
          let msg = "Camera error. Please check your browser settings.";
          if (err?.name === "NotAllowedError" || err?.name === "PermissionDeniedError") {
            msg =
              "Camera permission denied. Please allow camera access in Settings → Safari → Camera.";
          } else if (err?.name === "NotFoundError" || err?.name === "DevicesNotFoundError") {
            msg = "No camera found on this device.";
          } else if (err?.name === "NotReadableError") {
            msg = "Camera is in use by another app. Close other apps using the camera.";
          } else if (err?.name === "SecurityError") {
            msg =
              "Camera blocked in this context. On iPhone, open this site directly in Safari (not from the home screen or inside another app).";
          }
          setCameraError(msg);
          stopScanning();
        };

        const startScanInterval = () => {
          if (scanIntervalRef.current) {
            clearInterval(scanIntervalRef.current);
          }
          scanIntervalRef.current = setInterval(() => {
            if (!videoRef.current || !canvasRef.current) return;
            const video = videoRef.current;
            const canvas = canvasRef.current;
            const ctx = canvas.getContext("2d");
            if (video.readyState !== video.HAVE_ENOUGH_DATA) return;

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imageData.data, canvas.width, canvas.height);
            if (code && code.data) {
              const normalized = normalizeUPC(code.data);
              if (normalized) {
                const isApproved = APPROVED_UPCS.has(normalized);
                setLastScannedCode(normalized);
                setApprovalStatus(isApproved ? "APPROVED" : "NOT_APPROVED");
                stopScanning();
              }
            }
          }, 300);
        };

        const startScanning = async () => {
          setScanning(true);
          setCameraError(null);
          setShowVideo(true);
          setApprovalStatus(null);
          setLastScannedCode(null);

          if (
            !navigator.mediaDevices ||
            typeof navigator.mediaDevices.getUserMedia !== "function"
          ) {
            setCameraError(
              "Camera access is not supported in this browser or mode. On iPhone, open this URL directly in Safari (not from the home screen)."
            );
            setShowVideo(false);
            setScanning(false);
            return;
          }

          try {
            const stream = await navigator.mediaDevices.getUserMedia({
              video: { facingMode: isRearCamera ? "environment" : "user" },
              audio: false,
            });
            streamRef.current = stream;

            if (videoRef.current) {
              videoRef.current.srcObject = stream;
              videoRef.current.setAttribute("playsinline", "true");
              videoRef.current.setAttribute("muted", "true");
              videoRef.current.muted = true;
              await videoRef.current.play();
            }

            startScanInterval();
          } catch (err) {
            handleCameraError(err);
          }
        };

        const toggleCamera = () => {
          const next = !isRearCamera;
          setIsRearCamera(next);
          if (scanning) {
            stopScanning();
            setTimeout(() => startScanning(), 300);
          }
        };

        return (
          <div className="min-h-screen flex items-center justify-center p-4">
            <div className="max-w-md w-full bg-white shadow-lg rounded-lg p-4 space-y-4">
              <h1 className="text-xl font-bold text-center text-green-800">
                4LEAF Tobacco Checker
              </h1>
              <p className="text-sm text-gray-600 text-center">
                Scan a UPC. The app will show only APPROVED or NOT APPROVED.
              </p>

              <div className="space-y-3">
                <button
                  onClick={scanning ? stopScanning : startScanning}
                  className={`w-full py-2 rounded-md text-white font-semibold ${
                    scanning ? "bg-red-600" : "bg-green-700"
                  }`}
                >
                  {scanning ? "Stop Scanning" : "Start Scanning"}
                </button>

                <button
                  onClick={toggleCamera}
                  className="w-full py-2 rounded-md border border-gray-300 text-gray-700 text-sm"
                >
                  Switch to {isRearCamera ? "Front" : "Rear"} Camera
                </button>
              </div>

              {showVideo && (
                <div class
