<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>4LEAF Tobacco Checker</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0"
    />
    <!-- IMPORTANT: REMOVE PWA HOME-SCREEN BEHAVIOR ON IOS -->
    <!-- Do NOT use apple-mobile-web-app-capable here, it breaks camera in iOS PWAs. [web:8][web:25] -->

    <!-- Tailwind (optional, can remove if you prefer your own CSS) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React + ReactDOM -->
    <script
      crossorigin
      src="https://unpkg.com/react@18/umd/react.production.min.js"
    ></script>
    <script
      crossorigin
      src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"
    ></script>

    <!-- Babel for JSX in this single file -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- jsQR for QR decoding -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  </head>

  <body class="bg-gray-100">
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useRef, useEffect } = React;

      function App() {
        const videoRef = useRef(null);
        const canvasRef = useRef(null);
        const [scanning, setScanning] = useState(false);
        const [scanResult, setScanResult] = useState(null);
        const [cameraError, setCameraError] = useState(null);
        const [showVideo, setShowVideo] = useState(false);
        const [isRearCamera, setIsRearCamera] = useState(true);
        const scanIntervalRef = useRef(null);
        const streamRef = useRef(null);

        // Clean up on unmount
        useEffect(() => {
          return () => {
            stopScanning();
          };
        }, []);

        const stopScanning = () => {
          setScanning(false);
          setShowVideo(false);
          if (scanIntervalRef.current) {
            clearInterval(scanIntervalRef.current);
            scanIntervalRef.current = null;
          }
          if (streamRef.current) {
            streamRef.current.getTracks().forEach((track) => track.stop());
            streamRef.current = null;
          }
        };

        const handleCameraError = (err) => {
          console.error("Camera error:", err.name, err.message);
          let msg = "Camera error. Please check your browser settings.";

          if (err.name === "NotAllowedError" || err.name === "PermissionDeniedError") {
            msg =
              "Camera permission denied. Please allow camera access in Settings → Safari → Camera.";
          } else if (err.name === "NotFoundError" || err.name === "DevicesNotFoundError") {
            msg = "No camera found on this device.";
          } else if (err.name === "NotReadableError") {
            msg = "Camera is in use by another app. Close other apps using the camera.";
          } else if (err.name === "SecurityError") {
            msg =
              "Camera blocked for this site or context. Open this page directly in Safari, not from the home screen or another app.";
          }

          setCameraError(msg);
          stopScanning();
        };

        const startScanInterval = () => {
          if (scanIntervalRef.current) {
            clearInterval(scanIntervalRef.current);
          }

          scanIntervalRef.current = setInterval(() => {
            if (!videoRef.current || !canvasRef.current) return;

            const video = videoRef.current;
            const canvas = canvasRef.current;
            const ctx = canvas.getContext("2d");

            if (video.readyState !== video.HAVE_ENOUGH_DATA) return;

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = ctx.getImageData(
              0,
              0,
              canvas.width,
              canvas.height
            );

            const code = jsQR(imageData.data, canvas.width, canvas.height);
            if (code && code.data) {
              setScanResult(code.data);
              stopScanning();
            }
          }, 300);
        };

        const startScanning = async () => {
          setScanning(true);
          setScanResult(null);
          setCameraError(null);
          setShowVideo(true);

          // iOS / Safari support & context guard
          if (
            !navigator.mediaDevices ||
            typeof navigator.mediaDevices.getUserMedia !== "function"
          ) {
            setCameraError(
              "Camera access is not supported in this browser or mode. On iPhone, open this URL directly in Safari (not from the home screen)."
            );
            setShowVideo(false);
            setScanning(false);
            return;
          }

          try {
            const stream = await navigator.mediaDevices.getUserMedia({
              video: {
                facingMode: isRearCamera ? "environment" : "user",
              },
              audio: false,
            });

            streamRef.current = stream;

            if (videoRef.current) {
              videoRef.current.srcObject = stream;
              // iOS-specific attributes
              videoRef.current.setAttribute("playsinline", "true");
              videoRef.current.setAttribute("muted", "true");
              videoRef.current.muted = true;
              await videoRef.current.play();
            }

            startScanInterval();
          } catch (err) {
            handleCameraError(err);
          }
        };

        const toggleCamera = async () => {
          const newIsRear = !isRearCamera;
          setIsRearCamera(newIsRear);

          if (scanning) {
            stopScanning();
            // small delay for iOS to release old stream
            setTimeout(() => {
              startScanning();
            }, 300);
          }
        };

        return (
          <div className="min-h-screen flex items-center justify-center p-4">
            <div className="max-w-md w-full bg-white shadow-lg rounded-lg p-4 space-y-4">
              <h1 className="text-xl font-bold text-center text-green-800">
                4LEAF Tobacco Checker
              </h1>

              <p className="text-sm text-gray-600 text-center">
                Tap &quot;Start Scanning&quot;, then allow camera access when Safari asks.
              </p>

              <div className="space-y-3">
                <button
                  onClick={scanning ? stopScanning : startScanning}
                  className={`w-full py-2 rounded-md text-white font-semibold ${
                    scanning ? "bg-red-600" : "bg-green-700"
                  }`}
                >
                  {scanning ? "Stop Scanning" : "Start Scanning"}
                </button>

                <button
                  onClick={toggleCamera}
                  className="w-full py-2 rounded-md border border-gray-300 text-gray-700 text-sm"
                >
                  Switch to {isRearCamera ? "Front" : "Rear"} Camera
                </button>
              </div>

              {showVideo && (
                <div className="space-y-2">
                  <div className="relative w-full bg-black rounded-md overflow-hidden">
                    <video
                      ref={videoRef}
                      className="w-full h-auto"
                      autoPlay
                      muted
                      playsInline
                    ></video>
                  </div>
                  <canvas
                    ref={canvasRef}
                    className="hidden"
                  ></canvas>
                </div>
              )}

              {scanResult && (
                <div className="p-3 rounded-md bg-green-50 border border-green-200 text-sm">
                  <div className="font-semibold text-green-800 mb-1">
                    Scan Result
                  </div>
                  <div className="break-all text-gray-800">{scanResult}</div>
                </div>
              )}

              {cameraError && (
                <div className="p-3 rounded-md bg-red-50 border border-red-200 text-sm">
                  <div className="font-semibold text-red-700 mb-1">
                    Camera Error
                  </div>
                  <div className="text-gray-800">{cameraError}</div>
                </div>
              )}
            </div>
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>
  </body>
</html>
